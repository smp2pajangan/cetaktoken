<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cetak Kartu Ujian | All in One CBT</title>
    <link href="https://aspd.jogjacbt.web.id/favicon.ico" rel="shortcut icon">
    <link rel="stylesheet" href="https://aspd.jogjacbt.web.id/assets/kartu/css/cetak.min.css">
    <script type="text/javascript" src="https://aspd.jogjacbt.web.id/assets/kartu/plugins/jquery/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="https://aspd.jogjacbt.web.id/assets/kartu/plugins/jquery/jquery-migrate-1.4.1.min.js"></script>
    <script type="text/javascript" src="https://aspd.jogjacbt.web.id/assets/kartu/plugins/qrcode/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOBCX8x60pYqxtXmXMz2xc5dwC3HJH5EE",
            authDomain: "ujian-online-berbasis-android.firebaseapp.com",
            databaseURL: "https://ujian-online-berbasis-android-default-rtdb.firebaseio.com",
            projectId: "ujian-online-berbasis-android",
            storageBucket: "ujian-online-berbasis-android.appspot.com",
            messagingSenderId: "923446282537",
            appId: "1:923446282537:web:60d374dde8aca61f6a0f38"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const kartuUjianRef = ref(database, 'kartu_ujian');

        function prosesFile() {
            console.log("Tombol Proses Diklik!");

            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    console.log("File berhasil dibaca oleh FileReader!");

                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    console.log("Data dari XLSX:", jsonData);

                    // Kirim data ke Firebase Realtime Database
                    jsonData.forEach(siswa => {
                        push(kartuUjianRef, siswa)
                            .then(() => {
                                console.log("Data siswa berhasil dikirim ke Firebase:", siswa);
                            })
                            .catch((error) => {
                                console.error("Error mengirim data ke Firebase:", error);
                            });
                    });

                    alert("Data dari file XLSX berhasil dikirim ke Firebase!");
                };

                reader.onerror = function(error) {
                    console.error("Terjadi kesalahan saat membaca file:", error);
                    alert("Terjadi kesalahan saat membaca file XLSX.");
                };

                reader.readAsArrayBuffer(file);
            } else {
                alert("Pilih file XLSX terlebih dahulu.");
            }
        }

        function tampilkanDataKartuUjian() {
            const mainContainer = document.createElement('div');
            mainContainer.className = 'page';
            const centerElement = document.createElement('center');
            const tableElement = document.createElement('table');
            tableElement.align = 'center';
            tableElement.width = '100%';
            const tbodyElement = document.createElement('tbody');

            onValue(kartuUjianRef, (snapshot) => {
                const data = snapshot.val();
                tbodyElement.innerHTML = ''; // Bersihkan data sebelumnya

                if (data) {
                    let row;
                    let cardCount = 0;
                    Object.keys(data).forEach(key => {
                        const kartu = data[key];

                        if (cardCount % 2 === 0) {
                            row = document.createElement('tr');
                            tbodyElement.appendChild(row);
                        }

                        const tdElement = document.createElement('td');
                        tdElement.style.padding = '3px';

                        const kartuTable = document.createElement('table');
                        kartuTable.style.width = '10.4cm';
                        kartuTable.style.border = '1px solid #666';
                        kartuTable.className = 'kartu';
                        const kartuTbody = document.createElement('tbody');

                        let innerHTML = `
                            <tr>
                                <td colspan="3" style="border-bottom:1px solid #666; padding: 0;">
                                    <table width="100%" class="kartu">
                                        <tbody>
                                            <tr>
                                                <td style="padding: 4px"><img src="https://aspd.jogjacbt.web.id/assets/kartu/img/tutwuri.jpg" height="40"></td>
                                                <td align="center" style="font-weight:bold; padding: 4px;">
                                                    KARTU LOGIN PESERTA <br/> ASESMEN STANDARISASI PENDIDIKAN DAERAH<br/>TAHUN PELAJARAN 2024/2025
                                                </td>
                                                <td style="padding: 4px; text-align: right">
                                                    <div class="qrcode" id="qr_${key}" data-value="${kartu['Nomor Peserta'] || ''}" style="float: right" title="${kartu['Nomor Peserta'] || ''}">
                                                        <canvas width="40" height="40" style="display: none;"></canvas>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            <tr><td width="105">Nama Peserta</td><td width="1">:</td><td>${kartu['Nama Lengkap'] || ''}</td></tr>
                            <tr><td>Kelas</td><td>:</td><td>${kartu.Kelas || ''}</td></tr>
                            <tr><td>Ruang</td><td>:</td><td>${kartu.Ruang || ''}</td></tr>
                            <tr><td>Username Login</td><td>:</td><td style="font-size:12px;font-weight:bold;">${kartu['Nomor Peserta'] || ''}</td></tr>
                            <tr><td>Password Login</td><td>:</td><td style="font-size:12px;font-weight:bold;">********</td></tr>
                            <tr><td colspan="3"></td></tr>
                            <tr>
                                <td colspan="3">
                                    <table width="100%">
                                        <tbody>
                                            <tr>
                                                <td valign="top" style="padding: 0">
                                                    <table style="border:solid 1px black">
                                                        <tbody>
                                                            <tr>
                                                                <td style="border-bottom:1px solid black"><i><b>Catatan:</b></i></td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Tetap semangat dan selalu patuhi protokol kesehatan.
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        `;

                        kartuTbody.innerHTML = innerHTML;
                        kartuTable.appendChild(kartuTbody);
                        tdElement.appendChild(kartuTable);
                        row.appendChild(tdElement);

                        // Generate QR code
                        setTimeout(() => {
                            const qrcodeDiv = document.getElementById(`qr_${key}`);
                            if (qrcodeDiv) {
                                new QRCode(qrcodeDiv, {
                                    text: kartu['Nomor Peserta'] || '',
                                    width: 40,
                                    height: 40
                                });
                            }
                        }, 10); // Penundaan singkat untuk memastikan div sudah dirender

                        cardCount++;
                    });
                } else {
                    tbodyElement.innerHTML = '<tr><td colspan="2">Tidak ada data kartu ujian.</td></tr>';
                }

                tableElement.appendChild(tbodyElement);
                centerElement.appendChild(tableElement);
                mainContainer.appendChild(centerElement);

                const hasilTabelDiv = document.getElementById('hasilTabel');
                hasilTabelDiv.innerHTML = ''; // Bersihkan tabel sebelumnya
                hasilTabelDiv.appendChild(mainContainer);
            });
        }

        function cetakKartu(key) {
            // Implementasikan logika untuk mengambil data berdasarkan key dan menampilkan satu kartu untuk dicetak
            alert(`Fungsi cetak kartu untuk key: ${key} akan diimplementasikan.`);
        }

        // Panggil fungsi untuk menampilkan data saat halaman dimuat
        tampilkanDataKartuUjian();
    </script>
</head>
<body>
    <h1>Pembuat Kartu Ujian</h1>

    <div>
        <a href="https://drive.google.com/uc?export=download&id=1ffhfPpQlKsuRgmXXB38q6HWM9KWsTAg3" id="downloadTemplate">Unduh Template XLSX</a>
    </div>

    <hr>

    <div>
        <label for="fileUpload">Unggah File XLSX yang Sudah Diisi:</label>
        <input type="file" id="fileUpload" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
    </div>

    <div>
        <button onclick="prosesFile()">Proses</button>
    </div>

    <div id="hasilTabel">
    </div>

    <div id="hasil" style="display:none;">
        <h2>Data dari File XLSX:</h2>
        <pre><code id="dataXLSX"></code></pre>
    </div>

    <script src="https://unpkg.com/xlsx/xlsx.full.min.js"></script>
</body>
</html>
